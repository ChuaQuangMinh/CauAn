<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Danh Sách Cầu An</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">

  <!-- Bootstrap Icons CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="index.css">
</head>

<body>
  <iframe id="pdfViewer" style="display: none;"></iframe>

  <div id="loadingOverlay">
    <div id="loadingSpinner" class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <nav class="navbar navbar-expand-lg navbar-light bg-transparent">
    <div class="container">
      <a class="navbar-brand" href="index.html">Chùa Quang Minh</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="index.html">Cầu An</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="ds.html">Danh Sách</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container ">
    <div class="card-header text-center">
      <h4>DANH SÁCH CẦU AN</h4>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4">
          <div class="input-group mb-3">
            <input type="text" class="form-control" placeholder="Tìm kiếm" name="tim_kiem" autocomplete="off">
          </div>
        </div>
        <div class="col-md-4">
          <div class="input-group mb-3">
            <select class="form-select" id="dynamicAddressFilter">
              <option value="">Chọn địa chỉ</option>
            </select>
          </div>
        </div>
              
        <div class="col-md-2">
          <!-- <button class="btn btn-sm btn-success mb-1 print-selected"><i class="bi bi-printer"></i> In tất cả đã
            chọn</button> -->
        </div>
        <div class="col-12 d-none">
          <div class="row">
            <div class="col-xl-2 col-lg-4 col-md-4 col-6">
              <div class="input-group mb-3">
                <select class="form-select" name="dc_1" id="dc_1">
                </select>
              </div>
            </div>
            <div class="col-xl-2 col-lg-4 col-md-4 col-6">
              <div class="input-group mb-3">
                <select class="form-select" name="dc_2" id="dc_2">
                </select>
              </div>
            </div>
            <div class="col-xl-2 col-lg-4 col-md-4 col-12">
              <div class="input-group mb-3">
                <select class="form-select" name="dc_3" id="dc_3">
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-bordered">
          <thead class="table-success">
            <tr>
              <th scope="col">Thông tin</th>
              <!-- <th scope="col" style="width: 1%;">Chọn(<span class="selected-count">0</span>)</th> -->
              <th scope="col" style="width: 4%;">Chức năng</th>
            </tr>
          </thead>
          <tbody id="TBody">
            <tr id="TRow" class="d-none">
              <td>
                <div class="row">
                  <div class="col-md-2">
                    <div class="mb-0">
                      <p class="ma_so"></p>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-0">
                      <p class="dai_dien"></p>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-0">
                      <p class="dia_chi"></p>
                    </div>
                  </div>
                  <div class="col-md-2 d-none">
                    <div class="mb-0">
                      <p class="so_dien_thoai"></p>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="mb-0">
                      <p class="trang_thai"></p>
                    </div>
                  </div>
                </div>
                <!-- Vùng hiển thị danh sách thành viên -->
                <div class="mt-3">
                  <!-- <h6 class="fw-bold">Danh sách thành viên:</h6> -->
                  <ul class="thanh_vien"></ul>
                </div>
              </td>
              <!-- <td class="custom-td">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="" id="defaultCheck1">
                </div>
              </td> -->
              <td class="custom-td">
                <!-- <a href="" class="btn btn-sm btn-info mb-1 view-button"><i class="bi bi-eye"></i></a>
                <a href="" class="btn btn-sm btn-primary mb-1 edit-button"><i class="bi bi-pencil"></i></a> -->
                <!-- <button class="btn btn-sm btn-success print-button mb-1" data-ma-so="your_ma_so_here"><i class="bi bi-printer"></i></button> -->
                <!-- <button class="btn btn-sm btn-secondary check-button mb-1" data-ma-so="your_ma_so_here">
                  <i class="bi bi-check"></i>
                </button> -->
              </td>              
            </tr>
          </tbody>
          <div id="noResults" class="text-center text-muted mt-3" style="display: none;">
            Không tìm thấy kết quả phù hợp.
          </div>
        </table>
      </div>

    </div>
  </div>

  <!-- jQuery -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
    crossorigin="anonymous"></script>

  <!-- Other scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.15/jspdf.plugin.autotable.min.js"></script>
  <script src="https://printjs-4de6.kxcdn.com/print.min.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="index.js"></script>
  <script>
    $(document).ready(function () {
      // // Lấy đối tượng td cần thêm sự kiện click
      // var td = document.querySelector('.clickable');

      // // Thêm sự kiện click vào td
      // td.addEventListener('click', function () {
      //   // Thực hiện hành động khi td được click
      //   alert('Bạn đã click vào TD này.');
      // });
      $(".print-selected").hide();
      showLoadingOverlay();
      $.getJSON(AppsScriptLink + "?page=all", function (data) {
        data.shift();
        $.each(data, function (key, value) {
          // console.log("Phần tử JSON hiện tại:", value); // In từng phần tử JSON
          var $row = $("#TRow").clone().removeClass('d-none'); // Clone the hidden row
          $row.find(".ma_so").text(value.maSo);
          $row.find(".dai_dien").text(value.daiDien);
          $row.find(".dia_chi").text(value.diaChi);
          $row.find(".so_dien_thoai").text(value.soDienThoai);
          var trangThai = value.trangThai;
          $row.find(".trang_thai").text(trangThai);
          if (trangThai === "Chưa in") {
            $row.find(".trang_thai").text("Chưa Biên Giấy").addClass("chua_in");
          } else if (trangThai === "R") {
            $row.find(".trang_thai").text("Đã Biên Giấy").addClass("da_in");
          }
          // Hiển thị danh sách thành viên
          var memberList = $row.find(".thanh_vien");
          if (value.thanhVien && value.thanhVien.length > 0) {
            value.thanhVien.forEach(function (member, index) {
              memberList.append(`
                <div>
                  ${index + 1}. <strong>${member.hoVaTen}</strong> 
                  <span style="color: red;">(${namHienTai - member.namSinh + 1}t)</span> 
                  <em>${member.nguoiSinh}</em>
                </div>
              `);
            });
          } else {
            memberList.append(`<div>Không có thông tin thành viên</div>`);
          }

          // // Thêm nút View với status=view
          // var maSoViewLink = "index.html?ma_so=" + value.maSo + "&status=view";
          // var viewButton = `<a href="${maSoViewLink}" class="btn btn-sm btn-info mb-1 view-button"><i class="bi bi-eye"></i></a>`;
          // $row.find(".custom-td").append(viewButton);

          // Thêm nút Edit với status=edit
          var maSoEditLink = "index.html?ma_so=" + value.maSo + "&status=edit";
          var editButton = `<a href="${maSoEditLink}" class="btn btn-sm btn-primary mb-1 edit-button"><i class="bi bi-eye"></i></a>`;
          $row.find(".custom-td").append(editButton);

          var $printButton = $row.find("button.print-button");
          $printButton.attr("data-ma-so", value.maSo); // Set the data-ma-so attribute
          $printButton.on("click", function () {
            var maSo = $(this).data('ma-so'); // Lấy giá trị data-ma-so
            showLoadingOverlay();
            generatePDF([maSo]); // Gọi hàm generatePDF với mã số
          });
          // var $checkButton = $row.find("button.check-button");
          // $checkButton.attr("data-ma-so", value.maSo); // Set the data-ma-so attribute
          // $checkButton.on("click", function () {
          //   var maSo = $(this).data('ma-so');
          //   tickPrint([maSo]);

          //   var currentStatus = $row.find(".trang_thai").text().trim();
          //   var newStatus = (currentStatus === "Chưa Biên Giấy") ? "Đã Biên Giấy" : "Chưa Biên Giấy";

          //   // Fix condition for "Tam Tai Chưa Biên Giấy"
          //   if (currentStatus === "Tam Tai Chưa Biên Giấy") {
          //     newStatus = "Đã Biên Giấy";
          //   }

          //   $row.find(".trang_thai").text(newStatus);

          //   if (newStatus === "Đã Biên Giấy") {
          //     $row.find(".trang_thai").addClass("da_in").removeClass("chua_in");
          //   } else if (newStatus === "Chưa Biên Giấy") {
          //     $row.find(".trang_thai").removeClass("da_in").addClass("chua_in");
          //   }
          // });

          // Kiểm tra trạng thái trước khi thêm nút
          if (trangThai === "R") {
            var $checkButton = $('<button class="btn btn-sm btn-secondary check-button mb-1"><i class="bi bi-check"></i></button>');
            $checkButton.attr("data-ma-so", value.maSo); // Set the data-ma-so attribute

            // Thêm sự kiện click cho nút
            $checkButton.on("click", function () {
              var maSo = $(this).data('ma-so');
              editStatusPrint([maSo]);

              var currentStatus = $row.find(".trang_thai").text().trim();
              var newStatus = (currentStatus === "Chưa Biên Giấy") ? "Đã Biên Giấy" : "Chưa Biên Giấy";

              $row.find(".trang_thai").text(newStatus);

              if (newStatus === "Đã Biên Giấy") {
                $row.find(".trang_thai").addClass("da_in").removeClass("chua_in");
              } else if (newStatus === "Chưa Biên Giấy") {
                $row.find(".trang_thai").removeClass("da_in").addClass("chua_in");
              }
            });

            // Thêm nút vào cột chức năng
            $row.find(".custom-td").append($checkButton);
          }

          $("#TBody").append($row); // Append the row to the table body

          // Ẩn dòng này sau khi thêm
          $row.hide(); // Ẩn toàn bộ dòng ngay sau khi thêm vào bảng
          $("#TBody").append($row); // Append the row to the table body
        });
        hideLoadingOverlay();
      });
      
      // Xử lý tìm kiếm
      $("input[name='tim_kiem']").on("keyup", function () {
        const searchText = $(this).val().trim().toLowerCase(); // Lấy giá trị tìm kiếm
        let addressSet = new Set(); // Tạo một tập hợp để lưu các địa chỉ duy nhất
        let hasResults = false;

        // Kiểm tra nếu ô tìm kiếm rỗng
        if (searchText === "") {
          $("#TBody tr").hide(); // Ẩn tất cả các dòng nếu không có từ khóa
          $("#noResults").hide(); // Ẩn thông báo "Không tìm thấy kết quả"
          $("#dynamicAddressFilter").html(`<option value="">Chọn địa chỉ</option>`); // Reset dropdown
          return; // Dừng tại đây
        }

        // Lặp qua từng dòng dữ liệu
        $("#TBody tr").each(function () {
          const rowData = $(this).text().toLowerCase(); // Nội dung dòng hiện tại
          const rowAddress = $(this).find(".dia_chi").text(); // Địa chỉ giữ nguyên giá trị gốc

          // Kiểm tra từ khóa có trong nội dung dòng
          if (rowData.indexOf(searchText) !== -1) {
            $(this).show(); // Hiển thị dòng nếu khớp
            addressSet.add(rowAddress); // Thêm địa chỉ vào tập hợp (giữ nguyên giá trị gốc)
            hasResults = true;
          } else {
            $(this).hide(); // Ẩn dòng nếu không khớp
          }
        });

        // Hiển thị thông báo "Không tìm thấy kết quả" nếu không có dòng nào khớp
        if (!hasResults) {
          $("#noResults").show();
        } else {
          $("#noResults").hide();
        }

        // Sắp xếp danh sách địa chỉ
        const sortedAddresses = Array.from(addressSet).sort((a, b) => {
          const aParts = a.split(',').reverse();
          const bParts = b.split(',').reverse();

          while (aParts.length < 3) aParts.push("");
          while (bParts.length < 3) bParts.push("");

          for (let i = 0; i < 3; i++) {
            if (aParts[i].trim() !== bParts[i].trim()) {
              return aParts[i].trim().localeCompare(bParts[i].trim());
            }
          }
          return 0;
        });

        // Cập nhật danh sách địa chỉ trong dropdown
        const $dropdown = $("#dynamicAddressFilter");
        $dropdown.html(`<option value="">Chọn địa chỉ</option>`); // Reset dropdown
        sortedAddresses.forEach((address) => {
          $dropdown.append(`<option value="${address}">${address}</option>`); // Giữ nguyên giá trị gốc
        });
      });

      // Khi người dùng chọn một địa chỉ từ dropdown
      $("#dynamicAddressFilter").on("change", function () {
        const selectedAddress = $(this).val(); // Địa chỉ được chọn (giữ nguyên giá trị gốc)
        const searchText = $("input[name='tim_kiem']").val().trim().toLowerCase(); // Từ khóa tìm kiếm

        let hasResults = false;

        // Lặp qua từng dòng dữ liệu
        $("#TBody tr").each(function () {
          const rowData = $(this).text().toLowerCase(); // Nội dung dòng hiện tại
          const rowAddress = $(this).find(".dia_chi").text(); // Địa chỉ giữ nguyên giá trị gốc

          // Kiểm tra từ khóa và địa chỉ
          const isMatch =
            (searchText === "" || rowData.indexOf(searchText) !== -1) &&
            (selectedAddress === "" || rowAddress === selectedAddress);

          if (isMatch) {
            $(this).show(); // Hiển thị dòng nếu khớp
            hasResults = true;
          } else {
            $(this).hide(); // Ẩn dòng nếu không khớp
          }
        });

        // Hiển thị thông báo nếu không có kết quả
        if (!hasResults) {
          $("#noResults").show();
        } else {
          $("#noResults").hide();
        }
      });





      // Mảng lưu trữ các hàng đã chọn
      var selectedRows = [];

      $("#TBody").on("change", ".form-check-input", function () {
        var maSo = $(this).closest("tr").find(".ma_so").text();

        // Kiểm tra xem nút chọn đã được chọn hay bỏ chọn
        if ($(this).prop("checked")) {
          selectedRows.push(maSo);
        } else {
          var index = selectedRows.indexOf(maSo);
          if (index !== -1) {
            selectedRows.splice(index, 1);
          }
        }

        // Cập nhật số lượng đã chọn và hiển thị
        var selectedCount = selectedRows.length;
        $(".selected-count").text(selectedCount);

        // Ẩn/hiện nút "In tất cả đã chọn" dựa trên số lượng đã chọn
        if (selectedCount > 0) {
          $(".print-selected").show();
        } else {
          $(".print-selected").hide();
        }
      });

      $(".print-selected").on("click", function () {
        if (selectedRows.length > 0) {
          showLoadingOverlay();
          generatePDF(selectedRows); // Gọi hàm generatePDF với danh sách mã số đã chọn
        } else {
          alert("Vui lòng chọn ít nhất một hàng để in.");
        }
      });
    });

  </script>

</body>

</html>